/* Copyright 2019 Thomas Baart <thomas@splitkb.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include QMK_KEYBOARD_H
#include "keymap_colemak.h"
#include "sendstring_colemak.h"

enum layers {
    _COLEMAK_DH = 0,
    /* _QWERTY, */
    /* _DVORAK, */
    /* _COLEMAK_DH, */
    _DK_DIACTRICS,
    _PL_DIACTRICS,
    _NAV,
    _SYM,
    _NUM,
    _FUNCTION,
    _ADJUST,
};


// Aliases for readability
/* #define QWERTY   DF(_QWERTY) */
/* #define QWERDH   DF(_QWERTY_DH) */
//#define COLEMAK  DF(_COLEMAK_DH)

#define SYM      TT(_SYM)
#define NAV      TT(_NAV)
#define NUM      TT(_NUM)
#define FKEYS    TT(_FUNCTION)
#define ADJUST   MO(_ADJUST)
#define _RESET    TO(_COLEMAK_DH)

#define HOME_A  MT(MOD_LGUI, CM_A)
#define HOME_R  MT(MOD_LALT, CM_R)
#define HOME_S  MT(MOD_LSFT, CM_S)
#define HOME_T  MT(MOD_LCTL, CM_T)
#define HOME_N  MT(MOD_RCTL, CM_N)
#define HOME_E  MT(MOD_RSFT, CM_E)
#define HOME_I  MT(MOD_LALT, CM_I)
#define HOME_O  MT(MOD_RGUI, CM_O)
#define ALT_PL  TT(_PL_DIACTRICS)
#define ALT_DK  TT(_DK_DIACTRICS)

enum custom_keycodes {
    // Polish
    PL_EOGO = SAFE_RANGE,// Ę
    PL_EURO, // €
    PL_OACU, // Ó
    PL_AOGO, // Ą
    PL_SACU, // Ś
    PL_LSTR, // Ł
    PL_ZDOT, // Ż
    PL_ZACU, // Ź
    PL_CACU, // Ć
    PL_NACU, // Ń
    // Danish
    DK_UACU, // Ú
    DK_YACU, // Ý
    DK_AACU, // Á
    DK_ACIR, // Å
    DK_EACU, // É
    DK_IACU, // Í
    DK_ASH,  // Æ
    DK_ODIA  // Ø
};

// Note: LAlt/Enter (ALT_ENT) is not the same thing as the keyboard shortcut Alt+Enter.
// The notation `mod/tap` denotes a key that activates the modifier `mod` when held down, and
// produces the key `tap` when tapped (i.e. pressed and released).

// clang-format off
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/*
 * Base Layer: Colemak
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * | Bksp   | Q    |  W   |  F   | P    | B    |                              | J    | L    | U    | Y    | "    | Bksp   |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * | Tab    | A    | R    | S    | T    | G    |                              | M    | N    | E    | I    | O    | Ent    |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * | AltGrp | Z    | X    | C    | D    | V    | ADJ  | CAPS |  | FKEY |      | :    | K    | H    | ,    | .    | ?      |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        | MUTE | Esc  | Spc  | NUM  | NAV  |  | DK   | SYM  | Rsft | PL   | REST |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */


    [_COLEMAK_DH] = LAYOUT(
     KC_BSPC , CM_Q ,  CM_W   ,  CM_F  ,   CM_P ,   CM_B ,                                        CM_J,  CM_L  ,  CM_U , CM_Y   ,CM_DQUO, KC_BSPC,
     KC_TAB  ,HOME_A,  HOME_R ,  HOME_S,  HOME_T,   CM_G ,                                        CM_M,  HOME_N, HOME_E, HOME_I ,HOME_O,  KC_ENT,
     KC_RALT , CM_Z ,  CM_X   ,  CM_C  ,   CM_D ,   CM_V , ADJUST ,KC_CAPS,     FKEYS  , _______, CM_COLN,CM_K ,  CM_H , CM_COMM,CM_DOT,  CM_QUES,
                                KC_MUTE, KC_ESC , KC_SPC , NUM    , NAV   ,     ALT_DK , SYM    , KC_RSFT,ALT_PL, _RESET
    ),
/*
 * Layer template
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |      |      |      |      |      |                              |      | Ł    | €    |      |      |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        | Ą    |      | Ś    |      |      |                              |      | Ń    | Ę    |      | Ó    |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        | Ż    | Ź    | Ć    |      |      |      |      |  |      |      |      |      |      |      |      |        |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_PL_DIACTRICS] = LAYOUT(
      _______, _______, _______, _______, _______, _______,                                     _______, PL_LSTR, PL_EURO, _______, _______, _______,
      _______, PL_AOGO, _______, PL_SACU, _______, _______,                                     _______, PL_NACU, PL_EOGO, _______, PL_OACU, _______,
      _______, PL_ZDOT, PL_ZACU, PL_CACU, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
                                 _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),

/*
 * Layer template
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |      |      |      |      |      |                              |      |      | Ú    | Ý    |      |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        | Á    | Å    |      |      |      |                              |      |      | É    | Í    | Ø    |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        | Æ    |      |      |      |      |      |      |  |      |      |      |      |      |      |      |        |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_DK_DIACTRICS] = LAYOUT(
      _______, _______, _______, _______, _______, _______,                                     _______, _______, DK_UACU, DK_YACU, _______, _______,
      _______, DK_AACU, DK_ACIR, _______, _______, _______,                                     _______, _______, DK_EACU, DK_IACU, DK_ODIA, _______,
      _______, DK_ASH , _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
                                 _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),
/*
 * Nav Layer: Media, navigation
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |      |      |      |      |      |                              | PgUp | Home | PgDn | End  | VolUp| Delete |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        |  GUI |  Alt | Shift| Ctrl |      |                              |  ←   |   ↓  |   ↑  |   →  | VolDn| Insert |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        |      |      |      |      |      |      |ScLck |  |      |      | Pause|M Prev|M Play|M Next|VolMut| PrtSc  |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_NAV] = LAYOUT(
      _______, _______, _______, _______, _______, _______,                                     KC_PGUP, KC_HOME, KC_UP,   KC_END,  _______, KC_DEL,
      _______, KC_LGUI, KC_LALT, KC_LSFT, KC_LCTL, _______,                                     KC_PGDN, KC_LEFT, KC_DOWN, KC_RGHT, _______, KC_INS,
      _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, KC_PSCR,
                                KC_PAUSE, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),

/*
 * Sym Layer: Symbols
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |      |      | <    | >    | ~    |                              | %    | -    | =    | $    | '    |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        | (    | )    | {    | }    | @    |                              | /    | _    | +    | |    | \    |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        |      |      | [    | ]    | `    |      |      |  |      |      | ;    | #    | ^    | &    | *    | !      |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_SYM] = LAYOUT(
      _______, _______, _______, CM_LABK, CM_RABK, CM_TILD,                                     CM_PERC, CM_MINS, CM_EQL , CM_DLR , CM_QUOT, _______,
      _______, CM_LPRN, CM_RPRN, CM_LCBR, CM_RCBR, CM_AT  ,                                     CM_SLSH, CM_UNDS, CM_PLUS, CM_PIPE, CM_BSLS, _______,
      _______, _______, _______, CM_LBRC, CM_RBRC, CM_GRV , _______, _______, _______, _______, CM_SCLN, CM_HASH, CM_CIRC, CM_AMPR, CM_ASTR, CM_EXLM,
                                 _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),

/*
 * Num Layer: Numbers
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        | /    | 1    | 2    | 3    | +    |                              |      |      |      |      |      |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        | 0    | 4    | 5    | 6    | -    |                              |      | Ctrl | Shift| Alt  | GUI  |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        | *    | 7    | 8    | 9    | =    |      |      |  |      |      |      |      |      |      |      |        |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_NUM] = LAYOUT(
      _______, CM_SLSH, CM_1   , CM_2   , CM_3   , CM_PLUS,                                     _______, _______, _______, _______, _______, _______,
      _______, CM_0   , CM_4   , CM_5   , CM_6   , CM_MINS,                                     _______, KC_RCTL, KC_RSFT, KC_LALT, KC_RGUI, _______,
      _______, CM_ASTR, CM_7   , CM_8   , CM_9   , CM_EQL , _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
                                 _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),
/*
 * Function Layer: Function keys
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |  F12 |  F1  |  F2  |  F3  |      |                              |      |      |      |      |      |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        |  F10 |  F4  |  F5  |  F6  |      |                              |      | Ctrl | Shift|  Alt |  GUI |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        |  F11 |  F7  |  F8  |  F9  |      |      |      |  |      |      |      |      |      |      |      |        |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_FUNCTION] = LAYOUT(
      _______,  KC_F12,  KC_F1 ,  KC_F2 ,  KC_F3 , _______,                                     _______, _______, _______, _______, _______, _______,
      _______,  KC_F10,  KC_F4 ,  KC_F5 ,  KC_F6 , _______,                                     _______, KC_RCTL, KC_RSFT, KC_LALT, KC_RGUI, _______,
      _______,  KC_F11,  KC_F7 ,  KC_F8 ,  KC_F9 , _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
                                 _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
    ),

/*
 * Adjust Layer: Default layer settings, RGB
 *
 * ,-------------------------------------------.                              ,-------------------------------------------.
 * |        |      |      |      |      |      |                              |      |      |      |      |      |        |
 * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
 * |        |      |      |      |      |      |                              | TOG  | SAI  | HUI  | VAI  | MOD  |        |
 * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
 * |        |      |      |      |      |      |      |      |  |      |      |      | SAD  | HUD  | VAD  | RMOD |        |
 * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        |      |      |      |      |      |  |      |      |      |      |      |
 *                        `----------------------------------'  `----------------------------------'
 */
    [_ADJUST] = LAYOUT(
      _______, _______, _______, _______, _______, _______,                                    _______, _______, _______, _______,  _______, _______,
      _______, _______, _______, _______, _______, _______,                                    RGB_TOG, RGB_SAI, RGB_HUI, RGB_VAI,  RGB_MOD, _______,
      _______, _______, _______, _______, _______, _______,_______, _______, _______, _______, _______, RGB_SAD, RGB_HUD, RGB_VAD, RGB_RMOD, _______,
                                 _______, _______, _______,_______, _______, _______, _______, _______, _______, _______
    ),

// /*
//  * Layer template
//  *
//  * ,-------------------------------------------.                              ,-------------------------------------------.
//  * |        |      |      |      |      |      |                              |      |      |      |      |      |        |
//  * |--------+------+------+------+------+------|                              |------+------+------+------+------+--------|
//  * |        |      |      |      |      |      |                              |      |      |      |      |      |        |
//  * |--------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+--------|
//  * |        |      |      |      |      |      |      |      |  |      |      |      |      |      |      |      |        |
//  * `----------------------+------+------+------+------+------|  |------+------+------+------+------+----------------------'
//  *                        |      |      |      |      |      |  |      |      |      |      |      |
//  *                        |      |      |      |      |      |  |      |      |      |      |      |
//  *                        `----------------------------------'  `----------------------------------'
//  */
//     [_LAYERINDEX] = LAYOUT(
//       _______, _______, _______, _______, _______, _______,                                     _______, _______, _______, _______, _______, _______,
//       _______, _______, _______, _______, _______, _______,                                     _______, _______, _______, _______, _______, _______,
//       _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______, _______,
//                                  _______, _______, _______, _______, _______, _______, _______, _______, _______, _______
//     ),
};

#ifdef ENCODER_ENABLE
bool encoder_update_user(uint8_t index, bool clockwise) {

    if (index == 0) {
        // Volume control
        if (clockwise) {
            tap_code(KC_VOLU);
        } else {
            tap_code(KC_VOLD);
        }
    } else if (index == 1) {
        // Page up/Page down
        if (clockwise) {
            tap_code(KC_WH_D);
        } else {
            tap_code(KC_WH_U);
        }
    }
    return false;
}
#endif

struct AltKey {
    uint16_t trigger;
    uint16_t prefix;
    uint16_t key;
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    uint8_t mod_state = get_mods();

    const int key_len = 18;
    struct AltKey keys[] = {
        { PL_EOGO, CM_G,  CM_E },
        { PL_AOGO, CM_G,  CM_A },
        { PL_EURO, KC_NO, CM_5 },
        { PL_CACU, CM_T,  CM_C },
        { PL_NACU, CM_T,  CM_N },
        { PL_OACU, CM_T,  CM_O },
        { PL_SACU, CM_T,  CM_S },
        { PL_ZACU, CM_T,  CM_Z },
        { PL_ZDOT, CM_DOT,CM_Z },
        { PL_LSTR, KC_NO, CM_L },

        { DK_UACU, CM_T,  CM_U },
        { DK_YACU, CM_T,  CM_Y },
        { DK_AACU, CM_T,  CM_A },
        { DK_EACU, CM_T,  CM_E },
        { DK_IACU, CM_T,  CM_I },
        { DK_ACIR, KC_NO, CM_W },
        { DK_ASH,  KC_NO, CM_Z },
        { DK_ODIA, KC_NO, CM_P },
    };

        for (int i = 0; i < key_len; i++) {
            struct AltKey key = keys[i];
            if (key.trigger == keycode) {
                if (record->event.pressed) {
                    if (key.prefix != KC_NO) {
                        clear_mods();
                        tap_code16(RALT(key.prefix));
                        set_mods(mod_state);

                        tap_code16(key.key);
                    }
                    else {
                        tap_code16(RALT(key.key));
                    }
                }
                break;
            }
        }
    return true;
}
